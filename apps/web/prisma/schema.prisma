// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model GithubInstallations {
  id                   BigInt                       @id @default(autoincrement()) @map("id") @db.BigInt
  uuid                 String                       @unique @default(uuid()) @map("uuid") @db.VarChar(36)
  code                 String?                      @map("code") @db.VarChar(20)
  installationId       Int                          @unique @map("installation_id") @db.Integer()
  suspended            Boolean?                     @default(false) @map("suspended") @db.Boolean
  githubUsers          GithubUsers[]                @relation("GithubInstallationsGithubUsers")
  selectedRepositories GithubSelectedRepositories[] @relation("GithubInstallationsSelectedRepos")
  createdAt            DateTime                     @default(now()) @map("created_at")
  updatedAt            DateTime                     @updatedAt @map("updated_at")

  @@map(name: "github_installations")
}

model GithubSelectedRepositories {
  id                 BigInt              @id @default(autoincrement()) @map("id") @db.BigInt
  uuid               String              @unique @default(uuid()) @map("uuid") @db.VarChar(36)
  installation       GithubInstallations @relation("GithubInstallationsSelectedRepos", fields: [installationId], references: [id], onDelete: Cascade)
  installationId     BigInt              @map("installation_id") @db.BigInt
  githubRepositoryId Int                 @map("github_repository_id") @db.Integer
  nodeId             String              @map("node_id") @db.VarChar(255)
  name               String              @map("name") @db.VarChar(255)
  fullName           String              @map("full_name") @db.VarChar(255)
  private            Boolean             @default(false) @map("private") @db.Boolean
  triggers           Triggers[]          @relation("TriggersRepositories")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")

  @@unique([installationId, githubRepositoryId])
  @@map("github_selected_repositories")
}

model GithubUsers {
  id                    BigInt              @id @default(autoincrement()) @map("id") @db.BigInt
  uuid                  String              @unique @default(uuid()) @map("uuid") @db.VarChar(36)
  installation          GithubInstallations @relation("GithubInstallationsGithubUsers", fields: [installationId], references: [id], onDelete: Cascade)
  installationId        BigInt              @unique @map("installation_id") @db.BigInt
  githubId              Int                 @unique @map("github_id") @db.Integer
  login                 String              @unique @map("login") @db.VarChar(255)
  nodeId                String              @map("node_id") @db.VarChar(20)
  avatarUrl             String?             @map("avatar_url") @db.VarChar(255)
  gravatarId            String?             @map("gravatar_id") @db.VarChar(255)
  htmlUrl               String?             @map("html_url") @db.VarChar(255)
  type                  String              @map("type") @db.VarChar(255)
  name                  String?             @map("name") @db.VarChar(255)
  company               String?             @map("company") @db.VarChar(255)
  blog                  String?             @map("blog") @db.VarChar(255)
  location              String?             @map("location") @db.VarChar(255)
  email                 String?             @map("email") @db.VarChar(255)
  accessToken           String?             @map("access_token") @db.VarChar(255)
  expiresIn             Int?                @map("expires_in") @db.Integer
  refreshToken          String?             @map("refresh_token") @db.VarChar(255)
  refreshTokenExpiresIn Int?                @map("refresh_token_expires_in") @db.Integer
  scope                 String?             @map("scope") @db.VarChar(255)
  tokenType             String?             @map("token_type") @db.VarChar(20)
  habiticaUser          HabiticaUsers?      @relation("HabiticaUsersGithubUsers")
  triggers              Triggers[]          @relation("GithubUsersTriggers")
  webhookLogs           WebhookLogs[]       @relation("GithubUsersWebhookLogs")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@map(name: "github_users")
}

model HabiticaUsers {
  id           BigInt      @id @default(autoincrement()) @map("id") @db.BigInt
  uuid         String      @unique @default(uuid()) @map("uuid") @db.VarChar(36)
  githubUser   GithubUsers @relation("HabiticaUsersGithubUsers", fields: [githubUserId], references: [id], onDelete: Cascade)
  githubUserId BigInt      @unique @map("github_user_id") @db.BigInt
  userId       String      @unique @map("user_id") @db.VarChar(255)
  apiToken     String      @map("api_token") @db.VarChar(255)
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@map(name: "habitica_users")
}

model Triggers {
  id             BigInt                       @id @default(autoincrement()) @map("id") @db.BigInt
  uuid           String                       @unique @default(uuid()) @map("uuid") @db.VarChar(36)
  githubUser     GithubUsers                  @relation("GithubUsersTriggers", fields: [githubUserId], references: [id], onDelete: Cascade)
  githubUserId   BigInt                       @map("github_user_id") @db.BigInt
  isActive       Boolean                      @default(true) @map("is_active")
  event          String                       @map("event") @db.VarChar(255)
  repositories   GithubSelectedRepositories[] @relation("TriggersRepositories")
  taskTitle      String                       @map("task_title") @db.VarChar(255)
  taskAlias      String?                      @map("task_alias") @db.VarChar(255)
  taskNote       String?                      @map("task_note") @db.VarChar(255)
  taskPriority   Float                        @default(1) @map("task_priority")
  taskTags       Json?                        @map("task_tags")
  taskAttribute  Attribute                    @default(str) @map("task_attribute")
  taskFrequency  Frequency                    @default(daily) @map("task_frequency")
  scoreDirection Direction                    @default(up) @map("score_direction")
  createdAt      DateTime                     @default(now()) @map("created_at")
  updatedAt      DateTime                     @updatedAt @map("updated_at")

  @@map(name: "triggers")
}

model WebhookLogs {
  id           BigInt      @id @default(autoincrement()) @map("id") @db.BigInt
  uuid         String      @unique @default(uuid()) @map("uuid") @db.VarChar(36)
  deliveryUuid String      @unique @map("delivery_uuid") @db.VarChar(36)
  event        String      @map("event") @db.VarChar(255)
  signature    String      @map("signature") @db.VarChar(255)
  hookId       String      @map("hook_id") @db.VarChar(255)
  githubUser   GithubUsers @relation("GithubUsersWebhookLogs", fields: [githubUserId], references: [id], onDelete: Cascade)
  githubUserId BigInt      @map("github_user_id") @db.BigInt
  payload      Json?       @map("payload") @db.JsonB
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@map("webhook_logs")
}

enum Frequency {
  daily
  weekly
  monthly
}

enum Attribute {
  str
  int
  con
  per
}

enum Direction {
  up
  down
}
